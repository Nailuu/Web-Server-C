#include "server.h"
#include "error.h"
#include "http_header.h"
#include "routing.h"
#include "file.h"

Server *init_server(int port, int backlog)
{
  Server *server = NULL;
  struct sockaddr_in socket_params;
  int socket_fd;

  // Create TCP Socket and return socket file descriptor
  verify((socket_fd = socket(AF_INET, SOCK_STREAM, 0)),
         "Socket creation");

  socket_params.sin_family = AF_INET; // ipv4
  socket_params.sin_port = htons(port);
  socket_params.sin_addr.s_addr = INADDR_ANY;

  verify(bind(socket_fd, (struct sockaddr *)&socket_params, sizeof(socket_params)),
         "Socket binding");

  // Open socket and listen to given port with the given backlog
  verify(listen(socket_fd, backlog),
         "Socket listening");

  // Allocate server structure
  server = (Server*)malloc(sizeof(server));
  if (server == NULL)
    return (NULL);

  // Populate server structure
  server->socket = socket_fd;

  return (server);
}

void close_server(Server *server)
{
  close(server->socket);
  free(server);
}

int handle_connection(int client_socket, Route *route)
{
  char buffer[4096] = {0};
  char *request_info;
  char *content;
  char *requested_page;
  Route *file_route;
  int method;

  if (client_socket < 0)
    return (0);

  // Read http request from client
  if (read(client_socket, buffer, sizeof(buffer)) == 4096)
  {
    http_too_big(client_socket);
    return (1);
  }

  // Extract first line of request header and other into content 
  request_info = buffer;
  content = strchr(buffer, '\n');
  *content = '\0';
  content++;

  // Extract requested file 
  requested_page = get_http_request_url(request_info);
  if (requested_page == NULL)
    return (0);

  // Extract HTTP Method
  method = get_http_method(request_info);
  if (method == 1)
	  printf("METHOD: 'GET'\n");
  else if (method == 2)
    printf("METHOD: 'POST'\n");
  else 
  {
    http_invalid_method(client_socket);
    return (1);
  }

	printf("URL: '%s'\n", requested_page);

  // Get file location in route list
  file_route = search_route(route, requested_page);
  // Return 404 if not route found
  if (file_route == NULL)
  {
    http_not_found(client_socket);
    return (1);
  }
  // Call function for GET or POST Method
  else
  {
    printf("PATH TO FILE: %s\n\n", file_route->value);

    // GET - Read then write to client socket the content of the file
    if (method == 1)
      send_file(client_socket, file_route->value) == 0)

    // POST - Truncate file content to request header content
    else if (method == 2)
      post_file(client_socket, file_route->value) == 0)
  }

  return (1);
}
